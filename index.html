<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MiresHabar - Премиум Мессенджер</title>
  
  <!-- PWA Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MiresHabar">
  <meta name="theme-color" content="#6a1b9a">
  <meta name="description" content="Премиум мессенджер MiresHabar с расширенными функциями">
  
  <!-- Base64 Manifest -->
  <link rel="manifest" href="data:application/json;charset=utf-8;base64,ewogICJuYW1lIjogIk1pcmVzSGFiYXIiLAogICJzaG9ydF9uYW1lIjogIk1pcmVzSGFiYXIiLAogICJkZXNjcmlwdGlvbiI6ICLQnNC10YHRgtC10YDQvdC10L3QuNC1IE1pcmVzSGFiYXIiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiIsCiAgInRoZW1lX2NvbG9yIjogIiM2YTFiOWEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vaW1nLmljb25zOC5jb20vZmxhdC8xMDI0L3RlYS5wbmciLAogICAgICAic2l6ZXMiOiAiMTgweDE4MCIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pbWcuaWNvbnM4LmNvbS9mbGF0LzEwMjQvdGVhLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ">
  
  <!-- External Icons -->
  <link rel="apple-touch-icon" href="https://img.icons8.com/flat/1024/tea.png">
  <link rel="icon" type="image/png" href="https://img.icons8.com/flat/1024/tea.png">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Обновленная цветовая схема */
    :root {
      --primary: #6a1b9a;
      --primary-dark: #4a148c;
      --primary-light: #9c27b0;
      --accent: #ff9800;
      --accent-light: #ffb74d;
      --text: #ffffff;
      --text-secondary: #b0b0b0;
      --bg: #121212;
      --card-bg: #1e1e1e;
      --card-hover: #2a2a2a;
      --success: #4caf50;
      --error: #f44336;
      --warning: #ff9800;
      --online: #4caf50;
      --offline: #f44336;
      --typing: #ff9800;
      --gradient-start: #4a148c;
      --gradient-end: #6a1b9a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
      background: linear-gradient(135deg, var(--bg), #1a1a2e);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Шапка приложения */
    #app-header {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      padding: 18px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-icon {
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .app-title {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: linear-gradient(to right, #fff, #ffd180);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 18px;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    /* Основной контейнер приложения */
    #app {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Боковая панель контактов */
    #contacts-panel {
      width: 100%;
      background: var(--card-bg);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .contacts-header {
      padding: 20px;
      background: rgba(106, 27, 154, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contacts-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .contacts-search {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-input {
      width: 100%;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.08);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .contacts-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .contact-item {
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .contact-item:hover {
      background: rgba(106, 27, 154, 0.2);
    }

    .contact-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }

    .contact-info {
      flex: 1;
    }

    .contact-name {
      font-weight: 600;
      font-size: 16px;
    }

    .contact-status {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--offline);
    }

    .status-dot.online {
      background: var(--online);
    }

    .status-dot.typing {
      background: var(--typing);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    /* Статус подключения */
    #status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(30, 30, 46, 0.8);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.online {
      background: var(--online);
      box-shadow: 0 0 8px var(--online);
    }

    .status-indicator.offline {
      background: var(--offline);
      box-shadow: 0 0 8px var(--offline);
    }

    .status-indicator.loading {
      background: var(--warning);
      box-shadow: 0 0 8px var(--warning);
      animation: pulse 1.5s infinite;
    }

    .typing-indicator {
      color: var(--accent-light);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-light);
      animation: bounce 1.5s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* Область сообщений */
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card-bg);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: radial-gradient(circle at top left, rgba(74, 20, 140, 0.1), transparent 60%);
    }

    .message {
      max-width: 80%;
      padding: 16px 20px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.4s ease;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease;
    }

    .message:hover {
      transform: translateY(-3px);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-incoming {
      align-self: flex-start;
      background: linear-gradient(135deg, rgba(74, 20, 140, 0.4), rgba(74, 20, 140, 0.2));
      border-bottom-left-radius: 5px;
    }

    .message-outgoing {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(106, 27, 154, 0.5), rgba(74, 20, 140, 0.4));
      border-bottom-right-radius: 5px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .username {
      font-weight: 600;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-badge {
      background: var(--accent);
      color: black;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }

    .timestamp {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
    }

    .message-content {
      line-height: 1.5;
      font-size: 16px;
    }

    .message-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: none;
      gap: 5px;
    }

    .message:hover .message-actions {
      display: flex;
    }

    .msg-action-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .msg-action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Форма отправки сообщений */
    #message-form-container {
      padding: 20px;
      background: rgba(30, 30, 46, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    #messageForm {
      display: flex;
      gap: 12px;
    }

    .input-group {
      flex: 1;
      display: flex;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50px;
      padding: 5px 5px 5px 20px;
      align-items: center;
    }

    #messageInput {
      flex: 1;
      padding: 14px 0;
      border: none;
      background: transparent;
      color: white;
      font-size: 16px;
      outline: none;
    }

    .input-actions {
      display: flex;
      gap: 5px;
    }

    .input-btn {
      background: transparent;
      border: none;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .input-btn:hover {
      color: var(--accent);
      background: rgba(255, 255, 255, 0.1);
    }

    #sendButton {
      background: var(--accent);
      color: black;
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 20px;
      box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
    }

    #sendButton:hover {
      background: var(--accent-light);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 15px rgba(255, 152, 0, 0.4);
    }

    #sendButton:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Кнопка установки PWA */
    .install-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      border-radius: 50px;
      padding: 14px 32px;
      margin: 20px auto;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      text-align: center;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);
    }

    .install-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(106, 27, 154, 0.6);
    }

    /* Модальные окна */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      animation: modalIn 0.4s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 25px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      text-align: center;
    }

    .modal-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-size: 16px;
    }

    .form-input:focus {
      border-color: var(--accent);
      outline: none;
    }

    .modal-footer {
      padding: 20px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      background: rgba(30, 30, 30, 0.8);
    }

    .btn {
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 16px;
    }

    .btn-primary {
      background: var(--accent);
      color: black;
    }

    .btn-primary:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Адаптивность */
    @media (min-width: 768px) {
      #app {
        flex-direction: row;
      }
      
      #contacts-panel {
        display: block;
        width: 300px;
        flex-shrink: 0;
      }
      
      .app-logo {
        gap: 15px;
      }
      
      .app-icon {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }
    }

    @media (max-width: 767px) {
      #app-header {
        padding: 15px;
      }
      
      .app-title {
        font-size: 1.5rem;
      }
      
      .header-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      #messageForm {
        flex-direction: column;
      }
      
      .input-group {
        padding: 5px 5px 5px 15px;
      }
      
      #sendButton {
        width: 100%;
        height: 52px;
        border-radius: 12px;
      }
      
      .modal-content {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Обновленная структура приложения -->
  <header id="app-header">
    <div class="header-left">
      <div class="app-logo">
        <div class="app-icon">
          <i class="fas fa-comment-alt"></i>
        </div>
        <h1 class="app-title">MiresHabar</h1>
      </div>
    </div>
    
    <div class="header-right">
      <div class="header-actions">
        <button class="header-btn" id="contactsToggle">
          <i class="fas fa-users"></i>
        </button>
        <button class="header-btn" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
        <button class="header-btn" id="settingsToggle">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
  </header>
  
  <div id="app">
    <!-- Панель контактов -->
    <aside id="contacts-panel">
      <div class="contacts-header">
        <h2 class="contacts-title">Контакты</h2>
        <button class="header-btn" id="newChatBtn">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      
      <div class="contacts-search">
        <input type="text" class="search-input" placeholder="Поиск контактов...">
      </div>
      
      <div class="contacts-list">
        <div class="contact-item">
          <div class="contact-avatar">A</div>
          <div class="contact-info">
            <div class="contact-name">Александр</div>
            <div class="contact-status">
              <span class="status-dot online"></span>
              <span>В сети</span>
            </div>
          </div>
        </div>
        
        <div class="contact-item">
          <div class="contact-avatar">М</div>
          <div class="contact-info">
            <div class="contact-name">Мария</div>
            <div class="contact-status">
              <span class="status-dot typing"></span>
              <span>Печатает...</span>
            </div>
          </div>
        </div>
        
        <div class="contact-item">
          <div class="contact-avatar">И</div>
          <div class="contact-info">
            <div class="contact-name">Иван Петров</div>
            <div class="contact-status">
              <span class="status-dot"></span>
              <span>Был в сети 2 часа назад</span>
            </div>
          </div>
        </div>
        
        <div class="contact-item">
          <div class="contact-avatar">Е</div>
          <div class="contact-info">
            <div class="contact-name">Екатерина</div>
            <div class="contact-status">
              <span class="status-dot online"></span>
              <span>В сети</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
    
    <!-- Основной чат -->
    <main id="chat-container">
      <div id="status-bar">
        <div class="connection-status">
          <span class="status-indicator online"></span>
          <span>Стабильное соединение</span>
        </div>
        <div class="typing-indicator">
          <i class="fas fa-pencil-alt"></i>
          <span>Мария печатает...</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
      
      <div id="messages">
        <div class="message message-incoming">
          <div class="message-header">
            <div class="username">
              Мария <span class="user-badge">VIP</span>
            </div>
            <div class="timestamp">10:25</div>
          </div>
          <div class="message-content">
            Привет! Как твои дела? Я тут нашла интересное место, куда можно сходить в выходные.
          </div>
          <div class="message-actions">
            <button class="msg-action-btn"><i class="fas fa-reply"></i></button>
            <button class="msg-action-btn"><i class="fas fa-heart"></i></button>
          </div>
        </div>
        
        <div class="message message-outgoing">
          <div class="message-header">
            <div class="username">
              Вы
            </div>
            <div class="timestamp">10:27</div>
          </div>
          <div class="message-content">
            Привет! Всё отлично, спасибо! Рассказывай, что за место? 😊
          </div>
          <div class="message-actions">
            <button class="msg-action-btn"><i class="fas fa-reply"></i></button>
            <button class="msg-action-btn"><i class="fas fa-heart"></i></button>
          </div>
        </div>
        
        <div class="message message-incoming">
          <div class="message-header">
            <div class="username">
              Мария <span class="user-badge">VIP</span>
            </div>
            <div class="timestamp">10:29</div>
          </div>
          <div class="message-content">
            Это новый арт-кафе в центре. Там очень крутой интерьер и живая музыка по вечерам. Хочешь сходить в субботу?
          </div>
          <div class="message-actions">
            <button class="msg-action-btn"><i class="fas fa-reply"></i></button>
            <button class="msg-action-btn"><i class="fas fa-heart"></i></button>
          </div>
        </div>
        
        <div class="message message-incoming">
          <div class="message-header">
            <div class="username">
              Мария <span class="user-badge">VIP</span>
            </div>
            <div class="timestamp">10:30</div>
          </div>
          <div class="message-content">
            Вот фото интерьера: 🖼️
          </div>
          <div class="message-actions">
            <button class="msg-action-btn"><i class="fas fa-reply"></i></button>
            <button class="msg-action-btn"><i class="fas fa-heart"></i></button>
          </div>
        </div>
      </div>
      
      <div id="message-form-container">
        <form id="messageForm">
          <div class="input-group">
            <input type="text" id="messageInput" placeholder="Напишите сообщение..." required>
            <div class="input-actions">
              <button type="button" class="input-btn" id="emojiBtn">
                <i class="far fa-smile"></i>
              </button>
              <button type="button" class="input-btn" id="attachBtn">
                <i class="fas fa-paperclip"></i>
              </button>
            </div>
          </div>
          <button type="submit" id="sendButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </main>
  </div>
  
  <button class="install-btn" id="installButton">
    <i class="fas fa-download"></i>
    Установить приложение
  </button>
  
  <!-- Модальное окно настроек -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Настройки профиля</h2>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Ваше имя</label>
          <input type="text" class="form-input" value="Гость_4F2A">
        </div>
        
        <div class="form-group">
          <label class="form-label">Статус</label>
          <input type="text" class="form-input" placeholder="Ваш статус...">
        </div>
        
        <div class="form-group">
          <label class="form-label">Тема оформления</label>
          <select class="form-input">
            <option>Фиолетовая (стандартная)</option>
            <option>Темно-синяя</option>
            <option>Изумрудная</option>
            <option>Темно-красная</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Уведомления</label>
          <div style="display: flex; gap: 15px; margin-top: 10px;">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" checked>
              Звуковые
            </label>
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" checked>
              Вибро
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeSettings">Отмена</button>
        <button class="btn btn-primary" id="saveSettings">Сохранить</button>
      </div>
    </div>
  </div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmRBqxgDcPQDIObFLR5wGM2DbYkaFjkkg",
      authDomain: "test-50b35.firebaseapp.com",
      databaseURL: "https://test-50b35-default-rtdb.firebaseio.com",
      projectId: "test-50b35",
      storageBucket: "test-50b35.appspot.com",
      messagingSenderId: "130001282916",
      appId: "1:130001282916:web:260ac627751eb91c23bc71",
      measurementId: "G-QPB5RMS1GR"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized");
      
      const auth = firebase.auth();
      const database = firebase.database();
      
      // DOM Elements
      const messagesDiv = document.getElementById('messages');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const installButton = document.getElementById('installButton');
      const contactsToggle = document.getElementById('contactsToggle');
      const settingsToggle = document.getElementById('settingsToggle');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings = document.getElementById('saveSettings');
      const themeToggle = document.getElementById('themeToggle');
      const emojiBtn = document.getElementById('emojiBtn');
      const attachBtn = document.getElementById('attachBtn');
      
      // Toggle contacts panel on mobile
      contactsToggle.addEventListener('click', () => {
        const contactsPanel = document.getElementById('contacts-panel');
        contactsPanel.style.display = contactsPanel.style.display === 'block' ? 'none' : 'block';
      });
      
      // Settings modal
      settingsToggle.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
      });
      
      closeSettings.addEventListener('click', () => {
        settingsModal.style.display = 'none';
      });
      
      saveSettings.addEventListener('click', () => {
        settingsModal.style.display = 'none';
        alert('Настройки успешно сохранены!');
      });
      
      // Theme toggle
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('light-theme');
        const icon = themeToggle.querySelector('i');
        if (document.body.classList.contains('light-theme')) {
          icon.classList.replace('fa-moon', 'fa-sun');
        } else {
          icon.classList.replace('fa-sun', 'fa-moon');
        }
      });
      
      // Emoji button
      emojiBtn.addEventListener('click', () => {
        const emojis = ['😊', '😂', '❤️', '👍', '👏', '🎉', '🙏', '🤔', '😍', '🥳'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        messageInput.value += randomEmoji;
        messageInput.focus();
      });
      
      // Attach button
      attachBtn.addEventListener('click', () => {
        alert('Функция прикрепления файлов в разработке. Скоро будет доступна!');
      });
      
      // Sign in anonymously
      auth.signInAnonymously()
        .then((userCredential) => {
          console.log("Signed in anonymously");
          sendButton.disabled = false;
          messageInput.focus();
          
          // Listen for new messages
          database.ref('messages')
            .orderByChild('timestamp')
            .limitToLast(50)
            .on('child_added', (snapshot) => {
              const message = snapshot.val();
              displayMessage(message);
            });
        })
        .catch((error) => {
          console.error("Auth error:", error);
        });

      // Display a message
      function displayMessage(message) {
        const isOutgoing = message.userId === auth.currentUser.uid;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
        
        const username = isOutgoing ? 'Вы' : (message.username || 'Гость');
        
        messageElement.innerHTML = `
          <div class="message-header">
            <div class="username">
              ${username}
            </div>
            <div class="timestamp">${formatTime(message.timestamp)}</div>
          </div>
          <div class="message-content">${message.text}</div>
          <div class="message-actions">
            <button class="msg-action-btn"><i class="fas fa-reply"></i></button>
            <button class="msg-action-btn"><i class="fas fa-heart"></i></button>
          </div>
        `;
        
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Send message handler
      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        if (!messageText) return;
        
        try {
          sendButton.disabled = true;
          
          // Check auth
          if (!auth.currentUser) {
            await auth.signInAnonymously();
          }
          
          // Send message
          await database.ref('messages').push({
            text: messageText,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userId: auth.currentUser.uid,
            username: `Гость_${auth.currentUser.uid.slice(0, 4)}`
          });
          
          messageInput.value = '';
        } catch (error) {
          console.error("Send error:", error);
        } finally {
          sendButton.disabled = false;
        }
      });

      // Monitor connection status
      database.ref('.info/connected').on('value', (snapshot) => {
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.connection-status span:last-child');
        
        if (snapshot.val() === true) {
          statusIndicator.className = 'status-indicator online';
          statusText.textContent = 'Стабильное соединение';
          sendButton.disabled = false;
        } else {
          statusIndicator.className = 'status-indicator offline';
          statusText.textContent = 'Нет соединения';
          sendButton.disabled = true;
        }
      });

      // ===== PWA Installation =====
      function isStandalone() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone;
      }
      
      if (isStandalone()) {
        installButton.style.display = 'none';
      } else {
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              installButton.style.display = 'none';
            }
            deferredPrompt = null;
          }
        });
      }

      // ===== Service Worker Registration =====
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('ServiceWorker зарегистрирован:', registration.scope);
            })
            .catch(error => {
              console.log('Ошибка регистрации ServiceWorker:', error);
            });
        });
      }

      // Auto focus on input
      messageInput.focus();
      
      // Add animation to messages on load
      setTimeout(() => {
        const messages = document.querySelectorAll('.message');
        messages.forEach((msg, index) => {
          setTimeout(() => {
            msg.style.animation = `fadeIn 0.4s ease ${index * 0.1}s forwards`;
          }, 100);
        });
      }, 500);
      
    } catch (error) {
      console.error("Initialization error:", error);
    }
  </script>
</body>
</html>
