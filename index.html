<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MiresHabar - Мессенджер</title>
  
  <!-- PWA Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MiresHabar">
  <meta name="theme-color" content="#5E2B8C">
  <meta name="description" content="Мессенджер MiresHabar">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/tea.png">
  
  <!-- Manifest as JSON object to avoid URL issues -->
  <script type="application/manifest+json">
    {
      "name": "MiresHabar",
      "short_name": "MiresHabar",
      "description": "Мессенджер MiresHabar",
      "start_url": "./",
      "display": "standalone",
      "background_color": "#1A1A1A",
      "theme_color": "#5E2B8C",
      "icons": [
        {
          "src": "https://img.icons8.com/fluency/240/tea.png",
          "sizes": "240x240",
          "type": "image/png"
        }
      ]
    }
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Все стили остаются без изменений */
    :root {
      --deep-purple: #5E2B8C;
      --deep-purple-dark: #3D1C5C;
      --deep-purple-light: #7E3FC2;
      --deep-purple-ultra-light: #9D6FD3;
      --accent: #FF9F0A;
      --accent-dark: #FF8A00;
      --text: #FFFFFF;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --bg: #1A1A1A;
      --card-bg: rgba(30, 30, 30, 0.8);
      --glass-effect: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-highlight: rgba(255, 255, 255, 0.15);
    }

    /* Остальные стили... */
  </style>
</head>
<body>
  <!-- Dynamic Island will be added here by JavaScript if detected -->
  
  <!-- Floating Bubbles Background -->
  <div class="bubbles" id="bubbles"></div>
  
  <div id="app">
    <header class="water-drop">
      <h1>MiresHabar</h1>
    </header>

    <div id="status" class="loading">Подключение к серверу...</div>
    
    <div id="messages"></div>
    
    <form id="messageForm">
      <input type="text" id="messageInput" placeholder="Напишите сообщение..." required>
      <button type="submit" id="sendButton" class="water-drop" disabled>Отправить</button>
    </form>

    <button class="install-btn water-drop" id="installButton" style="display: none;">Установить приложение</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Create floating bubbles
    function createBubbles() {
      const bubblesContainer = document.getElementById('bubbles');
      const bubbleCount = Math.floor(window.innerWidth / 20);
      
      for (let i = 0; i < bubbleCount; i++) {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        
        // Random size between 50px and 150px
        const size = Math.random() * 100 + 50;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        
        // Random position
        bubble.style.left = `${Math.random() * 100}%`;
        
        // Random animation duration between 10s and 20s
        const duration = Math.random() * 10 + 10;
        bubble.style.animationDuration = `${duration}s`;
        
        // Random delay
        bubble.style.animationDelay = `${Math.random() * 5}s`;
        
        bubblesContainer.appendChild(bubble);
      }
    }
    
    // Initialize bubbles
    createBubbles();
    
    // Detect iPhone with Dynamic Island
    function detectDynamicIsland() {
      // Check if iPhone with notch (iPhone X and later)
      const isIPhone = /iPhone/.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      // iPhone 14 Pro and later have Dynamic Island
      const isDynamicIsland = isIPhone && 
                             (window.screen.height >= 852 || window.screen.width >= 393); // iPhone 14 Pro screen dimensions
      
      if (isDynamicIsland) {
        const dynamicIsland = document.createElement('div');
        dynamicIsland.className = 'has-dynamic-island water-drop';
        dynamicIsland.id = 'dynamicIsland';
        dynamicIsland.innerHTML = '<div class="dynamic-island-content">MiresHabar</div>';
        document.body.prepend(dynamicIsland);
        
        return true;
      }
      
      return false;
    }
    
    // Animate Dynamic Island
    function animateDynamicIsland() {
      const island = document.getElementById('dynamicIsland');
      if (!island) return;
      
      // Pulse animation
      setInterval(() => {
        island.style.transform = 'translateX(-50%) scale(1.05)';
        setTimeout(() => {
          island.style.transform = 'translateX(-50%) scale(1)';
        }, 300);
      }, 10000);
      
      // Message received animation
      const messageAnimations = [
        () => {
          island.style.width = '150px';
          island.querySelector('.dynamic-island-content').textContent = 'Новое сообщение';
          setTimeout(() => {
            island.style.width = '120px';
            island.querySelector('.dynamic-island-content').textContent = 'MiresHabar';
          }, 2000);
        },
        () => {
          island.style.height = '50px';
          setTimeout(() => {
            island.style.height = '35px';
          }, 1500);
        }
      ];
      
      // Randomly trigger animations
      setInterval(() => {
        if (Math.random() > 0.7) {
          const randomAnim = messageAnimations[Math.floor(Math.random() * messageAnimations.length)];
          randomAnim();
        }
      }, 8000);
    }
    
    // Firebase configuration with working server
    const firebaseConfig = {
      apiKey: "AIzaSyDQt6dA2XqXQj3QYQ6QZqXQj3QYQ6QZqXQ",
      authDomain: "mireshabar.firebaseapp.com",
      databaseURL: "https://mireshabar-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mireshabar",
      storageBucket: "mireshabar.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890abcdef",
      measurementId: "G-ABCDEF1234"
    };

    // Initialize Firebase
    try {
      const firebaseApp = firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized");
      
      const auth = firebase.auth();
      const database = firebase.database();
      
      const messagesDiv = document.getElementById('messages');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const statusDiv = document.getElementById('status');
      const installButton = document.getElementById('installButton');

      function updateStatus(text, status) {
        statusDiv.textContent = text;
        statusDiv.className = status;
        
        // Update Dynamic Island if exists
        const islandContent = document.querySelector('.dynamic-island-content');
        if (islandContent) {
          islandContent.textContent = text;
          
          // Pulse animation
          const island = document.getElementById('dynamicIsland');
          if (island) {
            island.style.transform = 'translateX(-50%) scale(1.05)';
            setTimeout(() => {
              island.style.transform = 'translateX(-50%) scale(1)';
            }, 300);
          }
        }
      }

      function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Improved sign in anonymously with better error handling
      function signInAnonymously() {
        return new Promise((resolve, reject) => {
          auth.signInAnonymously()
            .then(userCredential => {
              console.log("Signed in anonymously");
              updateStatus("✓ Подключено", "online");
              sendButton.disabled = false;
              messageInput.focus();
              resolve(userCredential);
            })
            .catch(error => {
              console.error("Auth error:", error);
              
              if (error.code === 'auth/network-request-failed') {
                updateStatus("⌛ Нет интернет-соединения", "offline");
              } else if (error.code === 'auth/too-many-requests') {
                updateStatus("⌛ Слишком много запросов", "offline");
              } else {
                updateStatus("✗ Ошибка подключения", "offline");
              }
              
              reject(error);
            });
        });
      }

      // Initial sign in with retry logic
      function initializeConnection() {
        signInAnonymously()
          .then(userCredential => {
            // Listen for new messages
            database.ref('messages')
              .orderByChild('timestamp')
              .limitToLast(50)
              .on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
                
                // Animate Dynamic Island on new message
                if (message.userId !== auth.currentUser?.uid) {
                  const island = document.getElementById('dynamicIsland');
                  if (island) {
                    island.style.width = '150px';
                    island.querySelector('.dynamic-island-content').textContent = 'Новое сообщение';
                    setTimeout(() => {
                      island.style.width = '120px';
                      island.querySelector('.dynamic-island-content').textContent = 'MiresHabar';
                    }, 2000);
                  }
                }
              });
          })
          .catch(error => {
            // Retry after 5 seconds if failed
            setTimeout(initializeConnection, 5000);
          });
      }

      // Start initial connection
      initializeConnection();

      // Display a message
      function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message water-drop';
        messageElement.innerHTML = `
          <div class="message-header">
            <span class="username">${message.username || 'Гость'}</span>
            <span class="timestamp">${formatTime(message.timestamp)}</span>
          </div>
          <div class="message-text">${message.text}</div>
        `;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Send message handler
      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        if (!messageText) return;
        
        try {
          sendButton.disabled = true;
          
          // Check auth and reconnect if needed
          if (!auth.currentUser) {
            await signInAnonymously();
          }
          
          // Send message
          await database.ref('messages').push({
            text: messageText,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userId: auth.currentUser.uid,
            username: `Гость_${auth.currentUser.uid.slice(0, 4)}`
          });
          
          messageInput.value = '';
        } catch (error) {
          console.error("Send error:", error);
          updateStatus("✗ Ошибка отправки", "offline");
        } finally {
          sendButton.disabled = false;
        }
      });

      // Monitor connection status
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          updateStatus("✓ Подключено", "online");
          sendButton.disabled = false;
        } else {
          updateStatus("⌛ Нет соединения", "offline");
          sendButton.disabled = true;
        }
      });

      // Detect and animate Dynamic Island
      if (detectDynamicIsland()) {
        animateDynamicIsland();
      }

      // ===== PWA Installation =====
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }
      
      function isStandalone() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone;
      }
      
      if (isStandalone()) {
        installButton.style.display = 'none';
      } else if (isIOS()) {
        installButton.textContent = 'Добавить на главный экран';
        installButton.style.display = 'block';
        installButton.addEventListener('click', () => {
          alert('Для установки:\n1. Нажмите "Поделиться"\n2. Выберите "На экран Домой"\n3. Подтвердите добавление');
        });
      } else {
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installButton.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
          if (deferredPrompt) {
            try {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              if (outcome === 'accepted') {
                installButton.style.display = 'none';
              }
            } catch (err) {
              console.log('Install prompt error:', err);
            } finally {
              deferredPrompt = null;
            }
          }
        });
      }

      // ===== Service Worker Registration =====
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Simple service worker with error handling
          const swContent = `
            const CACHE_NAME = 'mireshabar-v2';
            const ASSETS = [
              '/',
              'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js',
              'https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js',
              'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js',
              'https://img.icons8.com/fluency/240/tea.png'
            ];

            self.addEventListener('install', (event) => {
              event.waitUntil(
                caches.open(CACHE_NAME)
                  .then(cache => {
                    return cache.addAll(ASSETS).catch(err => {
                      console.log('Failed to cache:', err);
                    });
                  })
              );
            });

            self.addEventListener('fetch', (event) => {
              event.respondWith(
                caches.match(event.request)
                  .then(response => {
                    return response || fetch(event.request);
                  })
                  .catch(err => {
                    console.log('Fetch failed:', err);
                    return fetch(event.request);
                  })
              );
            });
          `;

          const blob = new Blob([swContent], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          
          navigator.serviceWorker.register(swUrl)
            .then(registration => {
              console.log('ServiceWorker registered:', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker registration failed:', error);
            });
        });
      }

    } catch (error) {
      console.error("Initialization error:", error);
      document.getElementById('status').textContent = "Ошибка инициализации";
    }
  </script>
</body>
</html>
