<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (метаданные и стили остаются без изменений) ... -->
  <style>
    /* Добавим стили для отладки */
    .debug-info {
      background: rgba(25, 18, 51, 0.7);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.8rem;
      font-family: monospace;
      border: 1px solid var(--glass-border);
    }
  </style>
</head>
<body>
  <!-- ... (HTML структура без изменений) ... -->

  <script>
    // ... (код частиц и конфигурации Firebase без изменений) ...

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized");
      
      const auth = firebase.auth();
      const database = firebase.database();
      
      // Элементы UI
      const messagesDiv = document.getElementById('messages');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const statusDiv = document.getElementById('status');
      const installButton = document.getElementById('installButton');
      const errorContainer = document.getElementById('errorContainer');

      // Генерация ID чата (каждый час новый)
      function getCurrentChatId() {
        const now = new Date();
        return `chat_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}`;
      }

      // Показать ошибку пользователю
      function showError(message, details = "") {
        errorContainer.style.display = 'block';
        errorContainer.innerHTML = `
          <div class="error-message">
            ${message}
            ${details ? `<div class="debug-info">${details}</div>` : ''}
          </div>
        `;
        setTimeout(() => {
          errorContainer.style.display = 'none';
        }, 10000);
      }

      // Обновить статус подключения
      function updateStatus(text, status) {
        statusDiv.textContent = text;
        statusDiv.className = status;
      }

      // Форматирование времени
      function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Аутентификация с повторными попытками
      function signInWithRetry(attempt = 1) {
        auth.signInAnonymously()
          .then((userCredential) => {
            console.log("Анонимная аутентификация успешна");
            updateStatus("✓ Подключено к серверу", "online");
            sendButton.disabled = false;
            messageInput.focus();
            
            // Начинаем слушать сообщения
            startListening();
          })
          .catch((error) => {
            console.error("Ошибка аутентификации:", error);
            updateStatus("✗ Ошибка подключения", "offline");
            
            const nextAttempt = Math.min(attempt + 1, 5);
            const delay = Math.pow(2, attempt) * 1000; // Экспоненциальная задержка
            
            showError(
              "Ошибка подключения к серверу", 
              `Попытка ${nextAttempt}/5 через ${delay/1000} сек. Код: ${error.code}`
            );
            
            setTimeout(() => signInWithRetry(nextAttempt), delay);
          });
      }

      // Начать прослушивание сообщений
      function startListening() {
        const chatId = getCurrentChatId();
        console.log("Слушаем чат:", chatId);
        
        database.ref(`chats/${chatId}/messages`)
          .orderByChild('timestamp')
          .limitToLast(50)
          .on('child_added', (snapshot) => {
            const message = snapshot.val();
            displayMessage(message);
          }, (error) => {
            console.error("Ошибка получения сообщений:", error);
            showError("Ошибка загрузки сообщений", `Код: ${error.code}`);
          });

        // Очистка старых чатов
        cleanupOldChats();
      }

      // Отображение сообщения
      function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.innerHTML = `
          <div class="message-header">
            <span class="username">${message.username || 'Гость'}</span>
            <span class="timestamp">${formatTime(message.timestamp)}</span>
          </div>
          <div class="message-text">${message.text}</div>
        `;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Обработчик отправки сообщения
      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        if (!messageText) return;
        
        try {
          sendButton.disabled = true;
          errorContainer.style.display = 'none';
          
          // Проверяем аутентификацию
          if (!auth.currentUser) {
            console.log("Пользователь не аутентифицирован, пробуем войти...");
            await auth.signInAnonymously();
          }
          
          // Получаем ID чата
          const chatId = getCurrentChatId();
          const userId = auth.currentUser.uid;
          
          // Формируем сообщение
          const message = {
            text: messageText,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userId: userId,
            username: `Гость_${userId.slice(0, 4)}`
          };
          
          console.log("Отправка сообщения в чат:", chatId, message);
          
          // Отправляем сообщение
          const messagesRef = database.ref(`chats/${chatId}/messages`);
          const newMessageRef = messagesRef.push();
          
          await newMessageRef.set(message)
            .then(() => {
              console.log("Сообщение успешно отправлено");
              messageInput.value = '';
            })
            .catch((error) => {
              throw error;
            });
            
        } catch (error) {
          console.error("Ошибка отправки:", error);
          
          // Детализированная обработка ошибок
          let errorMessage = "Ошибка отправки сообщения";
          let errorDetails = `Код: ${error.code || 'N/A'}`;
          
          if (error.code === 'PERMISSION_DENIED') {
            errorMessage = "Ошибка прав доступа";
            errorDetails = "Проверьте правила безопасности Firebase";
          } else if (error.code === 'NETWORK_ERROR') {
            errorMessage = "Сетевая ошибка";
          }
          
          showError(errorMessage, errorDetails);
          updateStatus("✗ Ошибка отправки", "offline");
          
        } finally {
          sendButton.disabled = false;
        }
      });

      // Очистка старых чатов (старше 1 часа)
      function cleanupOldChats() {
        const now = new Date();
        const oneHourAgo = new Date(now - 60 * 60 * 1000);
        
        const thresholdDate = [
          oneHourAgo.getFullYear(),
          String(oneHourAgo.getMonth() + 1).padStart(2, '0'),
          String(oneHourAgo.getDate()).padStart(2, '0')
        ].join('');
        
        const thresholdHour = String(oneHourAgo.getHours()).padStart(2, '0');
        
        database.ref('chats').once('value').then((snapshot) => {
          const updates = {};
          
          snapshot.forEach((chatSnapshot) => {
            const chatId = chatSnapshot.key;
            const parts = chatId.split('_');
            
            if (parts.length !== 3) return;
            
            const chatDate = parts[1];
            const chatHour = parts[2];
            
            // Удаляем если дата меньше или (дата равна и час меньше)
            if (chatDate < thresholdDate || 
               (chatDate === thresholdDate && chatHour < thresholdHour)) {
              updates[chatId] = null;
            }
          });
          
          if (Object.keys(updates).length > 0) {
            database.ref('chats').update(updates)
              .then(() => console.log('Старые чаты очищены'))
              .catch(err => console.error('Ошибка очистки:', err));
          }
        });
      }

      // Мониторинг состояния подключения
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          updateStatus("✓ Подключено к серверу", "online");
          sendButton.disabled = false;
        } else {
          updateStatus("⌛ Нет соединения", "offline");
          sendButton.disabled = true;
        }
      });

      // Начать аутентификацию
      signInWithRetry();

      // ... (остальной код PWA и ServiceWorker без изменений) ...

    } catch (error) {
      console.error("Ошибка инициализации:", error);
      document.getElementById('status').textContent = "Ошибка инициализации";
      showError("Критическая ошибка приложения", error.message);
    }
  </script>
</body>
</html>
