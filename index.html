<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (head content remains the same) ... -->
</head>
<body>
  <!-- ... (body content remains the same) ... -->

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmRBqxgDcPQDIObFLR5wGM2DbYkaFjkkg",
      authDomain: "test-50b35.firebaseapp.com",
      databaseURL: "https://test-50b35-default-rtdb.firebaseio.com",
      projectId: "test-50b35",
      storageBucket: "test-50b35.appspot.com",
      messagingSenderId: "130001282916",
      appId: "1:130001282916:web:260ac627751eb91c23bc71",
      measurementId: "G-QPB5RMS1GR"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized");
      
      const auth = firebase.auth();
      const database = firebase.database();
      
      // DOM elements
      const authScreen = document.getElementById('authScreen');
      const chatContainer = document.getElementById('chatContainer');
      const userNameInput = document.getElementById('userNameInput');
      const saveNameBtn = document.getElementById('saveNameBtn');
      const currentUserName = document.getElementById('currentUserName');
      const contactsList = document.getElementById('contactsList');
      const messagesContainer = document.getElementById('messagesContainer');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const statusDiv = document.getElementById('status');
      const chatPartnerInfo = document.getElementById('chatPartnerInfo');
      const chatPartnerAvatar = document.getElementById('chatPartnerAvatar');
      
      // State variables
      let currentUser = null;
      let selectedChatPartner = null;
      let users = {};
      let userName = '';
      let userEmail = '';
      
      // Check if user has a saved name
      function checkSavedUser() {
        const savedName = localStorage.getItem('userName');
        const savedEmail = localStorage.getItem('userEmail');
        
        if (savedName && savedEmail) {
          userName = savedName;
          userEmail = savedEmail;
          startChatApp();
        } else {
          authScreen.style.display = 'flex';
          chatContainer.style.display = 'none';
        }
      }
      
      // Start chat application
      function startChatApp() {
        authScreen.style.display = 'none';
        chatContainer.style.display = 'flex';
        
        // Sign in with email/password for persistent identity
        auth.signInWithEmailAndPassword(userEmail, 'defaultPassword')
          .then((userCredential) => {
            currentUser = userCredential.user;
            console.log("Signed in:", currentUser.uid);
            
            // Save user in database with persistent ID
            saveUser(currentUser.uid, userName, userEmail);
            
            // Update UI
            currentUserName.textContent = userName;
            
            // Load users and set up listeners
            loadUsers();
            
            // Update status
            updateStatus("✓ Подключено к серверу", "online");
            sendButton.disabled = false;
          })
          .catch((error) => {
            // If user doesn't exist, create a new one
            if (error.code === 'auth/user-not-found') {
              auth.createUserWithEmailAndPassword(userEmail, 'defaultPassword')
                .then((userCredential) => {
                  currentUser = userCredential.user;
                  console.log("New user created:", currentUser.uid);
                  
                  // Save user in database
                  saveUser(currentUser.uid, userName, userEmail);
                  
                  // Update UI
                  currentUserName.textContent = userName;
                  
                  // Load users and set up listeners
                  loadUsers();
                  
                  // Update status
                  updateStatus("✓ Подключено к серверу", "online");
                  sendButton.disabled = false;
                })
                .catch((error) => {
                  console.error("Create user error:", error);
                  updateStatus("✗ Ошибка создания пользователя", "offline");
                });
            } else {
              console.error("Auth error:", error);
              updateStatus("✗ Ошибка подключения", "offline");
            }
          });
      }
      
      // Save user to database with persistent ID
      function saveUser(uid, name, email) {
        database.ref('users/' + email.replace('.', '_')).set({
          uid: uid,
          name: name,
          email: email,
          lastOnline: firebase.database.ServerValue.TIMESTAMP,
          online: true
        });
        
        // Set up disconnect handler
        database.ref('.info/connected').on('value', (snapshot) => {
          if (snapshot.val() === false) {
            // User disconnected
            database.ref('users/' + email.replace('.', '_')).update({
              online: false
            });
          }
        });
      }
      
      // Load users from database
      function loadUsers() {
        database.ref('users').on('value', (snapshot) => {
          users = snapshot.val() || {};
          
          // Remove current user from list
          const otherUsers = {...users};
          if (currentUser) {
            Object.keys(otherUsers).forEach(key => {
              if (otherUsers[key].email === userEmail) {
                delete otherUsers[key];
              }
            });
          }
          
          // Update contacts list
          updateContactsList(otherUsers);
        });
      }
      
      // Update contacts list
      function updateContactsList(usersList) {
        contactsList.innerHTML = '';
        
        Object.keys(usersList).forEach(key => {
          const user = usersList[key];
          const contact = document.createElement('div');
          contact.className = 'contact';
          contact.dataset.uid = user.uid;
          contact.dataset.email = user.email;
          
          // Get first letter for avatar
          const firstLetter = user.name.charAt(0).toUpperCase();
          
          contact.innerHTML = `
            <div class="contact-avatar">${firstLetter}</div>
            <div class="contact-info">
              <div class="contact-name">${user.name}</div>
              <div class="contact-status">${user.online ? 'онлайн' : 'был(а) недавно'}</div>
            </div>
          `;
          
          contact.addEventListener('click', () => {
            selectChatPartner(user.uid, user.name, user.email);
          });
          
          contactsList.appendChild(contact);
        });
      }
      
      // Select chat partner
      function selectChatPartner(uid, name, email) {
        selectedChatPartner = {uid, name, email};
        
        // Update UI
        chatPartnerInfo.querySelector('.name').textContent = name;
        chatPartnerAvatar.textContent = name.charAt(0).toUpperCase();
        
        // Highlight active contact
        document.querySelectorAll('.contact').forEach(contact => {
          contact.classList.remove('active');
          if (contact.dataset.uid === uid) {
            contact.classList.add('active');
          }
        });
        
        // Show message form
        messageForm.style.display = 'flex';
        
        // Load messages
        loadMessages(uid, email);
      }
      
      // Load messages for a chat
      function loadMessages(partnerId, partnerEmail) {
        // Clear existing messages
        messagesContainer.innerHTML = '';
        
        // Generate persistent chat ID using emails
        const chatId = [userEmail, partnerEmail].sort().join('_').replace(/\./g, '_');
        
        database.ref('chats/' + chatId)
          .orderByChild('timestamp')
          .on('value', (snapshot) => {
            messagesContainer.innerHTML = '';
            const messages = snapshot.val() || {};
            
            Object.keys(messages).forEach(key => {
              const message = messages[key];
              displayMessage(message);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          });
      }
      
      // Display a message
      function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.sender === currentUser.uid ? 'sent' : 'received'}`;
        
        const senderName = message.sender === currentUser.uid ? 
          'Вы' : users[message.senderEmail]?.name || message.senderName || 'Неизвестный';
        
        const timestamp = formatTime(message.timestamp);
        
        messageElement.innerHTML = `
          <div class="message-header">
            <span class="message-sender">${senderName}</span>
            <span class="message-timestamp">${timestamp}</span>
          </div>
          <div class="message-text">${message.text}</div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Format timestamp
      function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      
      // Update status
      function updateStatus(text, status) {
        statusDiv.textContent = text;
        statusDiv.className = status;
        statusDiv.style.display = 'block';
      }
      
      // Send message handler
      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        if (!messageText || !selectedChatPartner) return;
        
        try {
          sendButton.disabled = true;
          
          // Generate persistent chat ID using emails
          const chatId = [userEmail, selectedChatPartner.email].sort().join('_').replace(/\./g, '_');
          
          // Send message
          await database.ref('chats/' + chatId).push({
            text: messageText,
            sender: currentUser.uid,
            senderEmail: userEmail,
            senderName: userName,
            receiver: selectedChatPartner.uid,
            receiverEmail: selectedChatPartner.email,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          
          messageInput.value = '';
        } catch (error) {
          console.error("Send error:", error);
          updateStatus("✗ Ошибка отправки", "offline");
        } finally {
          sendButton.disabled = false;
        }
      });
      
      // Save username and start app
      saveNameBtn.addEventListener('click', () => {
        if (userNameInput.value.trim()) {
          userName = userNameInput.value.trim();
          // Use email-style identifier for persistence
          userEmail = `${userName.replace(/\s+/g, '').toLowerCase()}@mireshabar.com`;
          
          localStorage.setItem('userName', userName);
          localStorage.setItem('userEmail', userEmail);
          startChatApp();
        }
      });
      
      // Monitor connection status
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          updateStatus("✓ Подключено к серверу", "online");
          if (sendButton) sendButton.disabled = false;
          
          // Update user online status
          if (currentUser && userEmail) {
            database.ref('users/' + userEmail.replace('.', '_')).update({
              online: true,
              lastOnline: firebase.database.ServerValue.TIMESTAMP
            });
          }
        } else {
          updateStatus("⌛ Нет соединения", "offline");
          if (sendButton) sendButton.disabled = true;
        }
      });
      
      // Initialize app
      checkSavedUser();

    } catch (error) {
      console.error("Initialization error:", error);
      if (statusDiv) statusDiv.textContent = "Ошибка инициализации";
    }
  </script>
</body>
</html>
